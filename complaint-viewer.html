<!DOCTYPE html>
<html lang="en">
<head>
    <title>Complaints</title>
</head>
<body>
    <nav><a href="meeting-viewer.html">Meeting Viewer|</a><a href="meeting-submission.html">Meeting Creator|</a><a href="complaint-submission.html">Complaint Submission|</a><a href="login.html">Login</a></nav>
    <h1>Complaint Viewer</h1>
    <button id="updateAllComplaints">Update All(WIP) </button>
    <table>
        <thead>
            <tr id="complaintTableHead">
                <th>ID</th><th>Subject</th><th>Description</th><th>Meeting ID</th><th>Priority</th>
            </tr>
        </thead>
        <tbody id="complaintTableBody">
    
        </tbody>
    </table>
</body>
<script>
    const complaintTableBody = document.getElementById("complaintTableBody");
    const complaintTableHead = document.getElementById("complaintTableHead");

    const appUserJSON = localStorage.getItem("appUser"); //Gets the user from local storage. Will be undefined if not found

    async function getComplaints(){
        const response = await fetch("http://localhost:8080/complaints");
        const complaints = await response.json();
        return complaints;
    }

    async function renderComplaintsTable(complaints){
        const testComplaints = await getComplaints();
        const priorities = ["HIGH", "LOW", "IGNORED", "UNASSIGNED"]
        console.log(testComplaints);
        let count = 0;
        for(const complaint of testComplaints){
            const complaintRow = document.createElement("tr");

            const complaintIdData = document.createElement("td");
            complaintIdData.innerText = complaint.id;

            const complaintSubjectData = document.createElement("td");
            complaintSubjectData.innerText = complaint.subject;
            
            const complaintDescData = document.createElement("td");
            complaintDescData.innerText = complaint.description;

            const complaintMeetingTD = document.createElement("td");

            const complaintPrioritySelect = document.createElement("select");
            
            const complaintPriorityTD = document.createElement("td");

            let updateButton = null;

            const appUser = JSON.parse(appUserJSON);
            if(appUser !== null){
                if(appUser.role === "COUNCIL"){
                    let tempPriority = "";
                    complaintPrioritySelect.name = "priorities";
                    complaintPrioritySelect.id = "priorityId" + complaint.id;
                    for(const p of priorities){
                        if(p === complaint.priority){
                            //Add this option first.
                            const temp = document.createElement("option");
                            temp.value = p;
                            tempPriority = p;
                            temp.text = p;

                            complaintPrioritySelect.add(temp);
                            console.log("Found assigned priority" + temp.value);
                            break;
                        }
                    }
                    for(const p of priorities){

                            if(p !== tempPriority)
                            {
                                const temp = document.createElement("option");
                                temp.value = p;
                                temp.text = p;
                                console.log("Assigning priorities");
                                complaintPrioritySelect.add(temp);
                            }
                        }
                    complaintPriorityTD.appendChild(complaintPrioritySelect);

                    const complaintMeetingIdData = document.createElement("input");
                    complaintMeetingIdData.value = complaint.meetingId;
                    complaintMeetingIdData.id = "complaintMeeting" + complaint.id;
                    complaintMeetingTD.appendChild(complaintMeetingIdData);
                    console.log(appUser + "council");

                    if(count < 1){
                        const updateTH = document.createElement("th");
                        updateTH.innerText = "Update";
                        complaintTableHead.appendChild(updateTH);
                    }
                    count++;

                    updateButton = document.createElement("button");
                    updateButton.innerText = "Update";
                    updateButton.id = "updateComplaint";
                    updateButton.dataset.complaintID = complaint.id;
                }
                else if(appUser.role === "CONSTITUENT")
                {
                    complaintPriorityTD.innerText = complaint.priority;

                    complaintMeetingTD.innerText = complaint.meetingId; 
                    
                    console.log(appUser + "constituent");
                    updateButton = null;
                }
            }
            else{
                complaintPriorityTD.innerText = complaint.priority;

                complaintMeetingTD.innerText = complaint.meetingId;
                console.log(appUser + "null");
                updateButton = null;
            }
            
            complaintRow.appendChild(complaintIdData);
            complaintRow.appendChild(complaintSubjectData);
            complaintRow.appendChild(complaintDescData);
            complaintRow.appendChild(complaintMeetingTD);
            complaintRow.appendChild(complaintPriorityTD);
            if(updateButton !== null)
            {
                complaintRow.appendChild(updateButton);
            }

            complaintTableBody.appendChild(complaintRow);
        }
    }

    document.addEventListener("click", async event =>{
        const element = event.target;
        const complaintId = element.dataset.complaintID;
        const complaintPriority = document.getElementById("priorityId" + complaintId);
        const complaintMeeting = document.getElementById("complaintMeeting" + complaintId)
        //send the http with the data given
        if(element.id == "updateComplaint"){
            const updatePriority = await fetch(`http://localhost:8080/complaints/${complaintId}/${complaintPriority.value}`, {
            method:"PUT",
            headers:{
                "Content-Type":"application/json"
            }
        });
        const updateMeeting = await fetch(`http://localhost:8080/complaints/${complaintId}/meetings/${complaintMeeting.value}`, {
            method:"PUT",
            headers:{
                "Content-Type":"application/json"
            }
        });
        if(updatePriority.status === 200 && updateMeeting.status == 200){
            alert("Successfully updated");
            location.reload();
        }
        else
        {
            alert("Something went wrong updating that complaint.");
        }
        }


    });
    
    renderComplaintsTable();
</script>
</html>